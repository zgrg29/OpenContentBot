import os
import json
import requests
from dotenv import load_dotenv

# 预先加载环境变量
load_dotenv()

class Adapter:
    def __init__(self, config):
        """
        config 同样是 modules.processor 的内容
        """
        api_key = os.getenv("ALIYUN_API_KEY")
        if not api_key:
            raise ValueError("环境变量 ALIYUN_API_KEY 未设置，请检查 .env 文件。")
        
        self.api_key = api_key
        self.model = config['model']
        self.temperature = config.get('temperature', 0.7)
        self.base_url = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"

    def generate_content(self, raw_data, system_prompt):
        """
        请求阿里云百炼并返回结构化数据
        """
        try:
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }
            
            payload = {
                "model": self.model,
                "input": {
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": f"请处理以下原始数据并按 JSON 格式输出：\n{raw_data}"}
                    ]
                },
                "parameters": {
                    "result_format": "message",
                    "temperature": self.temperature
                }
            }
            
            response = requests.post(self.base_url, headers=headers, json=payload, timeout=30)
            
            if response.status_code == 200:
                result = response.json()
                # 获取生成的内容
                content_str = result['output']['choices'][0]['message']['content']
                return json.loads(content_str)
            else:
                print(f"[!] 阿里云百炼 API 错误: {response.status_code} - {response.text}")
                return {
                    "caption": "内容生成失败，请检查日志。",
                    "image_prompt": "Error placeholder",
                    "tags": []
                }
            
        except Exception as e:
            print(f"[!] 阿里云百炼 API 错误: {e}")
            return {
                "caption": "内容生成失败，请检查日志。",
                "image_prompt": "Error placeholder",
                "tags": []
            }